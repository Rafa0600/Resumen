<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Despachos - Mikra + Chaya</title>
    <meta name="theme-color" content="#0a0a0f">
    <meta name="description" content="Dashboard de despachos MercadoLibre - Mikra + Chaya">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Despachos">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&family=Outfit:wght@300;500;700;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Outfit', sans-serif;
            background: #0a0a0f;
            color: #e8e8f0;
            min-height: 100vh;
            padding: 16px;
        }

        .container { max-width: 600px; margin: 0 auto; }

        h1 {
            font-size: 22px;
            font-weight: 900;
            text-align: center;
            margin-bottom: 6px;
            letter-spacing: -0.5px;
        }
        h1 span { color: #FFE600; }

        .subtitle {
            text-align: center;
            color: #555;
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 20px;
        }

        .reload-btn {
            display: block;
            margin: 0 auto 20px;
            background: none;
            border: 1px solid #333;
            color: #888;
            padding: 8px 20px;
            border-radius: 8px;
            font-family: 'Outfit', sans-serif;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .reload-btn:hover { border-color: #FFE600; color: #FFE600; }
        .reload-btn:disabled { opacity: 0.3; cursor: wait; }

        /* Cuenta card */
        .cuenta-card {
            background: #12121a;
            border: 1px solid #1e1e2e;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 14px;
            position: relative;
            overflow: hidden;
        }
        .cuenta-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
        }
        .cuenta-card.mikra::before { background: linear-gradient(90deg, #9C27B0, #E040FB); }
        .cuenta-card.chaya::before { background: linear-gradient(90deg, #FF6B00, #FFB74D); }

        .cuenta-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        .cuenta-name {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: -0.3px;
        }
        .cuenta-card.mikra .cuenta-name { color: #E040FB; }
        .cuenta-card.chaya .cuenta-name { color: #FFB74D; }

        .cuenta-total {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            color: #666;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .stat-box {
            background: #0a0a0f;
            border: 1px solid #1e1e2e;
            border-radius: 12px;
            padding: 14px;
            text-align: center;
            transition: all 0.3s;
        }
        .stat-box:hover { border-color: #333; }

        .stat-number {
            font-family: 'JetBrains Mono', monospace;
            font-size: 32px;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 4px;
        }
        .stat-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 500;
        }
        .stat-sublabel {
            font-size: 10px;
            color: #444;
            font-family: 'JetBrains Mono', monospace;
            margin-top: 2px;
        }

        .stat-box.flex .stat-number { color: #00e676; }
        .stat-box.colecta .stat-number { color: #42a5f5; }
        .stat-box.imprimir .stat-number { color: #ff5252; }
        .stat-box.imprimir { border-color: #ff525233; }
        .stat-box.pendiente .stat-number { color: #666; }

        /* Print badge full width */
        .print-row {
            margin-top: 10px;
            background: #1a0a0a;
            border: 1px solid #ff525233;
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .print-row .print-label {
            font-size: 13px;
            color: #ff5252;
            font-weight: 500;
        }
        .print-row .print-number {
            font-family: 'JetBrains Mono', monospace;
            font-size: 24px;
            font-weight: 800;
            color: #ff5252;
        }

        /* Totales */
        .totales-card {
            background: linear-gradient(135deg, #12121a, #1a1a2e);
            border: 1px solid #FFE60033;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 14px;
        }
        .totales-card .cuenta-name { color: #FFE600; }
        .totales-card .stat-box { border-color: #FFE60022; }

        /* Loading */
        .loading-state {
            text-align: center;
            padding: 40px 0;
            color: #444;
        }
        .spinner {
            width: 30px; height: 30px;
            border: 3px solid #222;
            border-top-color: #FFE600;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .progress-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: #555;
            margin-top: 8px;
        }

        .last-update {
            text-align: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: #333;
            margin-top: 12px;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-in { animation: fadeUp 0.4s ease forwards; }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 0 0 #ff525200; }
            50% { box-shadow: 0 0 12px 2px #ff525244; }
        }
        .has-prints { animation: pulse-glow 2s ease infinite; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì¶ <span>Despachos</span></h1>
        <div class="subtitle" id="subtitle">Mikra + Chaya</div>

        <button class="reload-btn" id="reloadBtn" onclick="cargarTodo()">‚ü≥ Actualizar</button>

        <div id="heroTotal" style="display:none; text-align:center; margin-bottom:20px;">
            <div style="font-family:'JetBrains Mono',monospace; font-size:56px; font-weight:800; color:#FFE600; line-height:1;">
                <span id="heroNumber">0</span>
            </div>
            <div style="font-size:14px; color:#888; margin-top:4px;">paquetes para imprimir</div>
        </div>

        <div id="content">
            <div class="loading-state">
                <div class="spinner"></div>
                Cargando...
                <div class="progress-text" id="progress"></div>
            </div>
        </div>

        <div class="last-update" id="lastUpdate"></div>
    </div>

    <script>
        const CUENTAS = [
            {
                nombre: 'Mikra',
                proxy: 'https://mikra-flex-proxy.rafaelassir.workers.dev',
                css: 'mikra',
                colectaLabel: 'Recolecta',
                colectaDesc: 'ML pasa a buscar'
            },
            {
                nombre: 'Chaya',
                proxy: 'https://chaya-flex-proxy.rafaelassir.workers.dev',
                css: 'chaya',
                colectaLabel: 'Despacho',
                colectaDesc: 'Llevar a punto'
            }
        ];

        async function cargarTodo() {
            const btn = document.getElementById('reloadBtn');
            btn.disabled = true;
            btn.textContent = '‚ü≥ Cargando...';
            
            document.getElementById('heroTotal').style.display = 'none';
            document.getElementById('content').innerHTML = `
                <div class="loading-state">
                    <div class="spinner"></div>
                    Cargando paquetes...
                    <div class="progress-text" id="progress"></div>
                </div>
            `;

            const resultados = [];

            for (const cuenta of CUENTAS) {
                document.getElementById('progress').textContent = `${cuenta.nombre}...`;
                try {
                    const data = await cargarCuenta(cuenta);
                    resultados.push(data);
                } catch (e) {
                    console.error(`Error ${cuenta.nombre}:`, e);
                    resultados.push({
                        cuenta,
                        flex: 0, colecta: 0, imprimir: 0, buffered: 0, total: 0,
                        error: true
                    });
                }
            }

            renderResultados(resultados);
            
            btn.disabled = false;
            btn.textContent = '‚ü≥ Actualizar';
            
            const ahora = new Date();
            document.getElementById('lastUpdate').textContent = 
                `Actualizado: ${ahora.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit' })}`;
        }

        async function cargarCuenta(cuenta) {
            const tokenResp = await fetch(`${cuenta.proxy}/get-token`);
            const { access_token, user_id } = await tokenResp.json();

            const ships = new Map();
            
            // Buscar solo √≥rdenes con shipping ready_to_ship (mucho m√°s r√°pido)
            for (const shippingStatus of ['ready_to_ship', 'pending']) {
                let offset = 0;
                let keepGoing = true;
                
                while (keepGoing) {
                    document.getElementById('progress').textContent = 
                        `${cuenta.nombre}: buscando ${shippingStatus}...`;

                    const resp = await fetch(
                        `${cuenta.proxy}/api/orders/search?seller=${user_id}&offset=${offset}&limit=50&sort=date_desc&shipping.status=${shippingStatus}`,
                        { headers: { 'Authorization': `Bearer ${access_token}` } }
                    );
                    const data = await resp.json();
                    const orders = data.results || [];

                    if (orders.length === 0) break;

                    // Collect new shipment IDs
                    const newShipIds = [];
                    for (const o of orders) {
                        const sid = o.shipping?.id;
                        if (sid && !ships.has(sid)) newShipIds.push(sid);
                    }

                    // Fetch all new shipments in parallel
                    const shipResults = await Promise.all(
                        newShipIds.map(async (sid) => {
                            try {
                                const sr = await fetch(`${cuenta.proxy}/api/shipments/${sid}`, {
                                    headers: { 'Authorization': `Bearer ${access_token}` }
                                });
                                return await sr.json();
                            } catch (e) { return null; }
                        })
                    );

                    for (const s of shipResults) {
                        if (s?.id) ships.set(s.id, s);
                    }

                    // Si trajo menos de 50, no hay m√°s
                    if (orders.length < 50) break;
                    offset += 50;
                    if (offset >= 300) break; // Safety limit
                }
            }

            // Contar solo ready_to_print
            let flex = 0, colecta = 0, buffered = 0;
            
            ships.forEach(s => {
                if (s.substatus === 'ready_to_print') {
                    if (s.logistic_type === 'self_service') flex++;
                    else colecta++;
                } else if (s.substatus === 'buffered') {
                    buffered++;
                }
            });

            return {
                cuenta,
                flex,
                colecta,
                imprimir: flex + colecta,
                buffered,
                total: flex + colecta
            };
        }

        function renderResultados(resultados) {
            let html = '';

            // Cards por cuenta
            resultados.forEach((r, i) => {
                const c = r.cuenta;
                html += `
                    <div class="cuenta-card ${c.css} animate-in" style="animation-delay: ${i * 0.15}s">
                        <div class="cuenta-header">
                            <div class="cuenta-name">${c.nombre}</div>
                            <div class="cuenta-total">üñ®Ô∏è Imprimir: ${r.imprimir}</div>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-box flex">
                                <div class="stat-number">${r.flex}</div>
                                <div class="stat-label">üèçÔ∏è Flex</div>
                            </div>
                            <div class="stat-box colecta">
                                <div class="stat-number">${r.colecta}</div>
                                <div class="stat-label">üì¶ ${c.colectaLabel}</div>
                                <div class="stat-sublabel">${c.colectaDesc}</div>
                            </div>
                        </div>
                        ${r.buffered > 0 ? `
                        <div style="margin-top:10px; text-align:center; font-size:11px; color:#555;">
                            ‚è≥ ${r.buffered} pendiente${r.buffered > 1 ? 's' : ''} (buffered, a√∫n no listas)
                        </div>` : ''}
                    </div>
                `;
            });

            // Totales
            const totFlex = resultados.reduce((a, r) => a + r.flex, 0);
            const totColecta = resultados.reduce((a, r) => a + r.colecta, 0);
            const totImprimir = resultados.reduce((a, r) => a + r.imprimir, 0);
            const totBuffered = resultados.reduce((a, r) => a + r.buffered, 0);

            html += `
                <div class="totales-card animate-in" style="animation-delay: 0.3s">
                    <div class="cuenta-header">
                        <div class="cuenta-name">Total</div>
                        <div class="cuenta-total">üñ®Ô∏è Imprimir: ${totImprimir}</div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-box flex">
                            <div class="stat-number">${totFlex}</div>
                            <div class="stat-label">üèçÔ∏è Flex</div>
                        </div>
                        <div class="stat-box colecta">
                            <div class="stat-number">${totColecta}</div>
                            <div class="stat-label">üì¶ Colecta</div>
                        </div>
                    </div>
                    ${totBuffered > 0 ? `
                    <div style="margin-top:10px; text-align:center; font-size:11px; color:#555;">
                        ‚è≥ ${totBuffered} pendiente${totBuffered > 1 ? 's' : ''} (buffered)
                    </div>` : ''}
                </div>
            `;

            document.getElementById('content').innerHTML = html;
            
            // Hero total
            const heroEl = document.getElementById('heroTotal');
            heroEl.style.display = 'block';
            document.getElementById('heroNumber').textContent = totImprimir;
        }

        // Cargar al inicio
        cargarTodo();

        // Auto-refresh cada 5 minutos
        setInterval(() => {
            if (!document.getElementById('reloadBtn').disabled) {
                cargarTodo();
            }
        }, 5 * 60 * 1000);

        // Pull to refresh (mobile)
        let touchStartY = 0;
        document.addEventListener('touchstart', e => {
            if (window.scrollY === 0) touchStartY = e.touches[0].clientY;
        }, { passive: true });
        document.addEventListener('touchend', e => {
            const diff = e.changedTouches[0].clientY - touchStartY;
            if (diff > 120 && window.scrollY === 0 && !document.getElementById('reloadBtn').disabled) {
                cargarTodo();
            }
        }, { passive: true });

        // Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {});
        }
    </script>
</body>
</html>
