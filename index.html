<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üñ®Ô∏è Para Imprimir</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;600;700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'DM Sans', sans-serif;
            background: #0f0f13;
            color: #e8e8ef;
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
        }
        .app { max-width: 480px; width: 100%; }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .header h1 { font-size: 18px; font-weight: 700; color: #FFE600; }
        .fecha { 
            background: #FF6B00; color: white; padding: 4px 12px; 
            border-radius: 16px; font-size: 11px; font-weight: 700; 
        }

        /* GRAN NUMERO CENTRAL */
        .big-number {
            text-align: center;
            padding: 28px 20px;
            background: #1a1a22;
            border: 1px solid #2a2a3a;
            border-radius: 16px;
            margin-bottom: 16px;
        }
        .big-number .num {
            font-size: 72px;
            font-weight: 700;
            color: #FFE600;
            line-height: 1;
        }
        .big-number .sub {
            font-size: 13px;
            color: #8888a0;
            margin-top: 6px;
        }

        /* DESGLOSE */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        .card {
            background: #1a1a22;
            border: 1px solid #2a2a3a;
            border-radius: 12px;
            padding: 16px;
            position: relative;
            overflow: hidden;
        }
        .card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
        }
        .card.mikra { border-color: rgba(156,39,176,0.3); }
        .card.mikra::before { background: #9C27B0; }
        .card.chaya { border-color: rgba(255,107,0,0.3); }
        .card.chaya::before { background: #FF6B00; }

        .card-title {
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            display: inline-block;
        }
        .dot.mikra { background: #9C27B0; }
        .dot.chaya { background: #FF6B00; }

        .row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
        }
        .row:not(:last-child) { border-bottom: 1px solid #2a2a3a; }
        .row-label { font-size: 13px; color: #8888a0; }
        .row-num { font-size: 22px; font-weight: 700; color: #FFE600; }
        .row-num.zero { color: #3a3a4a; font-size: 20px; }

        /* LOADING */
        .loading {
            text-align: center;
            padding: 50px 20px;
        }
        .spinner {
            width: 36px; height: 36px;
            border: 3px solid #2a2a3a;
            border-top-color: #FFE600;
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            margin: 0 auto 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .load-text { color: #FFE600; font-size: 14px; }
        .load-sub { color: #8888a0; font-size: 11px; margin-top: 4px; }

        /* FOOTER */
        .footer {
            text-align: center;
            margin-top: 16px;
            font-size: 11px;
            color: #555;
        }
        .footer a { color: #3483FA; cursor: pointer; text-decoration: underline; }

        .error-box {
            background: rgba(244,67,54,0.1);
            border: 1px solid rgba(244,67,54,0.3);
            color: #f44336;
            padding: 14px;
            border-radius: 10px;
            text-align: center;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="header">
            <h1>üñ®Ô∏è Para Imprimir</h1>
            <span class="fecha" id="fechaLabel">...</span>
        </div>
        <div id="content">
            <div class="loading">
                <div class="spinner"></div>
                <div class="load-text">Cargando...</div>
                <div class="load-sub" id="loadSub">Conectando</div>
            </div>
        </div>
    </div>

    <script>
        const CUENTAS = [
            { nombre: 'Mikra', proxy: 'https://mikra-flex-proxy.rafaelassir.workers.dev', color: 'mikra' },
            { nombre: 'Chaya', proxy: 'https://chaya-flex-proxy.rafaelassir.workers.dev', color: 'chaya' }
        ];

        async function getToken(cuenta) {
            try {
                const r = await fetch(`${cuenta.proxy}/get-token`);
                const d = await r.json();
                if (d.access_token) {
                    if (d.user_id) sessionStorage.setItem(`${cuenta.nombre.toLowerCase()}_uid`, d.user_id);
                    return d.access_token;
                }
                return null;
            } catch { return null; }
        }

        async function getSellerId(cuenta) {
            let id = sessionStorage.getItem(`${cuenta.nombre.toLowerCase()}_uid`);
            if (!id) {
                try {
                    const r = await fetch(`${cuenta.proxy}/get-token`);
                    const d = await r.json();
                    if (d.user_id) { id = d.user_id; sessionStorage.setItem(`${cuenta.nombre.toLowerCase()}_uid`, id); }
                } catch {}
            }
            return id;
        }

        function esPendienteSinDespachar(shipping) {
            const status = (shipping.status || '').toLowerCase();
            const history = shipping.status_history || {};
            // No fue despachado (no tiene date_shipped), no est√° cancelado, no entregado
            if (status === 'cancelled') return false;
            if (history.date_shipped) return false;
            if (history.date_delivered) return false;
            return true;
        }

        function getTipo(shipping) {
            return (shipping.logistic_type || '').toLowerCase() === 'self_service' ? 'flex' : 'colecta';
        }

        function esEntregaParaFecha(shipping, target) {
            const f = shipping.shipping_option?.estimated_delivery_time?.date ||
                      shipping.shipping_option?.estimated_delivery_final?.date;
            if (!f) return false;
            const d = new Date(f);
            d.setHours(0,0,0,0);
            return d.getTime() === target.getTime();
        }

        async function cargarCuenta(cuenta, token, targetDate) {
            const sellerId = await getSellerId(cuenta);
            if (!sellerId) return [];

            const from = new Date(targetDate); from.setDate(from.getDate() - 3);
            const to = new Date(targetDate); to.setDate(to.getDate() + 1); to.setHours(23,59,59,0);
            const fromStr = from.toISOString().split('.')[0] + '.000-00:00';
            const toStr = to.toISOString().split('.')[0] + '.000-00:00';
            const df = `&order.date_created.from=${encodeURIComponent(fromStr)}&order.date_created.to=${encodeURIComponent(toStr)}`;

            const pages = [];
            for (let p = 0; p < 20; p++) {
                pages.push(
                    fetch(`${cuenta.proxy}/api/orders/search?seller=${sellerId}&offset=${p*50}&limit=50&sort=date_desc${df}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }).then(r => r.json()).catch(() => ({ results: [] }))
                );
            }
            const allPages = await Promise.all(pages);
            const orders = allPages.flatMap(p => p.results || []);

            const shipResults = await Promise.all(orders.map(async (order) => {
                try {
                    const sid = order.shipping?.id;
                    if (!sid) return null;
                    const r = await fetch(`${cuenta.proxy}/api/shipments/${sid}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    const shipping = await r.json();
                    if (!esEntregaParaFecha(shipping, targetDate)) return null;
                    if (!esPendienteSinDespachar(shipping)) return null;
                    return { sid: shipping.id, tipo: getTipo(shipping) };
                } catch { return null; }
            }));

            // Dedup
            const seen = new Set();
            return shipResults.filter(r => {
                if (!r || seen.has(r.sid)) return false;
                seen.add(r.sid);
                return true;
            });
        }

        async function cargar() {
            const hoy = new Date();
            const dia = hoy.getDay();
            let fecha = new Date();
            let label = 'HOY';
            if (dia === 0) { fecha.setDate(fecha.getDate() + 1); label = 'LUNES'; }
            else if (dia === 6) { fecha.setDate(fecha.getDate() + 2); label = 'LUNES'; }
            fecha.setHours(0,0,0,0);

            document.getElementById('fechaLabel').textContent = `üìÖ ${label}`;

            const resultado = {};
            let totalGlobal = 0;

            for (const cuenta of CUENTAS) {
                const sub = document.getElementById('loadSub');
                if (sub) sub.textContent = `${cuenta.nombre}...`;

                try {
                    const token = await getToken(cuenta);
                    if (!token) {
                        resultado[cuenta.nombre] = { flex: 0, colecta: 0, color: cuenta.color, error: true };
                        continue;
                    }
                    const items = await cargarCuenta(cuenta, token, fecha);
                    const flex = items.filter(i => i.tipo === 'flex').length;
                    const colecta = items.filter(i => i.tipo === 'colecta').length;
                    resultado[cuenta.nombre] = { flex, colecta, color: cuenta.color };
                    totalGlobal += flex + colecta;
                } catch (e) {
                    resultado[cuenta.nombre] = { flex: 0, colecta: 0, color: cuenta.color, error: true };
                }
            }

            render(resultado, totalGlobal, label);
        }

        function render(data, total, label) {
            let flexTotal = 0, colectaTotal = 0;
            Object.values(data).forEach(d => { flexTotal += d.flex; colectaTotal += d.colecta; });

            let html = `
                <div class="big-number">
                    <div class="num">${total}</div>
                    <div class="sub">paquetes para imprimir ¬∑ ${flexTotal} Flex ¬∑ ${colectaTotal} Colecta</div>
                </div>
                <div class="grid">
            `;

            for (const [nombre, d] of Object.entries(data)) {
                if (d.error) {
                    html += `
                        <div class="card ${d.color}">
                            <div class="card-title"><span class="dot ${d.color}"></span> ${nombre}</div>
                            <div class="error-box">Sin conexi√≥n</div>
                        </div>`;
                    continue;
                }
                html += `
                    <div class="card ${d.color}">
                        <div class="card-title"><span class="dot ${d.color}"></span> ${nombre}</div>
                        <div class="row">
                            <span class="row-label">üèçÔ∏è Flex</span>
                            <span class="row-num ${d.flex === 0 ? 'zero' : ''}">${d.flex}</span>
                        </div>
                        <div class="row">
                            <span class="row-label">üìÆ Colecta</span>
                            <span class="row-num ${d.colecta === 0 ? 'zero' : ''}">${d.colecta}</span>
                        </div>
                    </div>`;
            }

            html += `</div>`;

            const now = new Date();
            html += `<div class="footer">${now.toLocaleString('es-AR', { timeZone:'America/Argentina/Buenos_Aires', hour:'2-digit', minute:'2-digit', hour12:false })} hs ¬∑ <a onclick="location.reload()">Recargar</a></div>`;

            document.getElementById('content').innerHTML = html;
        }

        window.addEventListener('DOMContentLoaded', cargar);
    </script>
</body>
</html>
